<div class="mx-6">
    <form [formGroup]="form" class="flex items-center gap-3">
        <mat-form-field appearance="fill" class="w-full">
            <mat-label>Intents</mat-label>
            <mat-select formControlName="intents" (ngModelChange)="formvalue(0)" multiple>
                <mat-option *ngFor="let intent of intentsName" [value]="intent">#{{intent}}</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
            <mat-label>Services</mat-label>
            <mat-select formControlName="services" (ngModelChange)="formvalue(0)" multiple>
                <mat-option *ngFor="let service of  servicesName" [value]="service">{{service}}</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
            <mat-label>Entities</mat-label>
            <mat-select formControlName="entities" (ngModelChange)="formvalue(0)" multiple>
                <mat-option *ngFor="let entity of entitiesName" [value]="entity">@{{entity}}</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" *ngIf="showSassProjectsFilter" class="w-full">
            <mat-label>projects</mat-label>
            <mat-select formControlName="projectId" (ngModelChange)="formvalue(0)" class="w-full">
                <mat-option *ngFor="let project of sassProjects" [value]="project._id">{{project?.brandInfo?.name}}</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
            <mat-label>Utterance</mat-label>
            <input (change)="formvalue(0)" (keydown.enter)="formvalue(1)" formControlName="search" matInput>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-full">
            <mat-label>UserId</mat-label>
            <div class="flex items-center">
                <input (change)="formvalue(0)" (keydown.enter)="formvalue(1)" class="w-[70%]" formControlName="userId" matInput><button type="button" *ngIf="form?.controls['userId']?.value" mat-raised-button class="bg-zinc-900 text-gray-100  hover:bg-orange-500 rounded-sm max-w-xs text-base"
                    (click)="removeUserId();$event.stopPropagation() ">{{form.controls['userId'].value}}</button>
            </div>
        </mat-form-field>
        <!-- <button (click)="formvalue()" (click)="getIntents();  getEntityies() ;getServices()">clicck</button> -->
    </form>

    <div (clickOutside)="ServiceDropdownOpen = false" class="p-2 border rounded-md w-96 ">
        <!-- Selected Chips -->
        <div *ngIf="selectedServices.length > 0" class="flex flex-wrap gap-2 mb-2 h-8 overflow-auto">
            <span *ngFor="let s of selectedServices" class="px-2 py-1 bg-orange-400 text-white rounded flex items-center">
      {{ s.name.replace('@', '') }}
      <button class="ml-2 text-white font-bold" (click)="removeService(s)">Ã—</button>
    </span>
        </div>

        <!-- Dropdown -->
        <div class="border rounded shadow relative">
            <div (click)="ServiceDropdownOpen = true" class="flex justify-center items-center bg-gray-100 p-2 font-bold">
                <span class="">Services</span>
                <button *ngIf="selectedServices.length > 0" class="px-2 py-1 text-sm bg-gray-600 text-white rounded  ml-auto" (click)="clearAllServices()">Clear</button>
            </div>

            <div class="p-2 absolute z-50 bg-white w-full" *ngIf="ServiceDropdownOpen">
                <input type="text" [(ngModel)]="searchServiceText" placeholder="Search services" class="w-full border rounded p-1 mb-2" />
                <div class="max-h-40 overflow-y-auto">
                    <div *ngFor="let service of filteredServices" class="flex items-center mb-1">
                        <input type="checkbox" [(ngModel)]="service.selected" class="mr-2" />
                        <label>{{ service.name }}</label>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <mat-tab-group>
        <mat-tab label="Conversations -{{conversationCount}}-">
            <table mat-table [dataSource]="dataSourceConversation">

                <!-- User Input Column -->
                <ng-container matColumnDef="User Input">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50"> User Input </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="w-44 maxHeight  overflow-auto mt-10 mb-4 mx-3 whitespace-pre-line">
                            <p class="font-bold">{{row.userInput}}</p>
                        </div>
                    </td>
                </ng-container>

                <!-- System Response Column -->
                <ng-container matColumnDef="System Response">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50"> System Response </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="maxCellHeight overflow-auto whitespace-pre-line" style="width:370px;">
                            <div class="" dir="rtl" *ngFor="let response of responses(row)">
                                <div class="mx-5 my-4 bg-slate-200 p-3 rounded-tr-md rounded-bl-md" *ngIf="response.type === 'text'">
                                    <p class="mt-3 text-base font-medium" [innerHtml]="getTextResponse(response)"></p>
                                </div>
                                <div class="mx-5 my-4 bg-slate-200 p-3 rounded-tr-md rounded-bl-md" *ngIf="response.type === 'yesno'">
                                    <p class="mt-3 text-base font-medium" [innerHtml]="getTextResponse(response)"></p>
                                </div>

                                <div class="mx-5 my-4 bg-slate-200 p-3 rounded-tr-md rounded-bl-md" dir="rtl" *ngIf="response.type === 'options'">
                                    <p class="text-base font-medium">{{response.title}}</p>
                                    <p *ngFor="let responseOptions of response.rOptions" class="border border-blue-900 rounded bg-white p-1 text-blue-900 text-base font-bold my-1 hover:bg-blue-900 hover:text-white">{{responseOptions.title}}</p>
                                </div>

                                <div class="mx-5 my-4 bg-slate-200 p-3 rounded-tr-md rounded-bl-md" dir="rtl" *ngIf="response.type === 'list'">
                                    <p class="text-base font-medium" [innerHtml]="response.title"></p>
                                    <p *ngFor="let responseOptions of response.rOptions" class="border border-blue-900 rounded bg-white p-1 text-blue-900 text-base font-bold my-1 hover:bg-blue-900 hover:text-white" [innerHtml]="responseOptions.title"></p>
                                </div>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- System Response Column -->
                <!-- <ng-container matColumnDef="System Response">
                    <th mat-header-cell *matHeaderCellDef class="bg-slate-50"> System Response </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="h-72 w-96 overflow-auto whitespace-pre-line ">
                            <div class="mx-5 mt-4 bg-slate-200 p-3 rounded-tr-md rounded-bl-md" dir="rtl" *ngIf="row.stepsResponseList.message">
                                <p *ngFor="let item of row.stepsResponseList.message" class="mt-3" [innerHtml]="item"></p>
                            </div>

                            <div class="mx-5 my-4 bg-slate-200 p-3 rounded-tr-md rounded-bl-md" dir="rtl" *ngIf="row.stepsResponseList.rOptionList.length>0">
                                <p>{{row.stepsResponseList.rOptionTitle}}</p>
                                <p *ngFor="let item of row.stepsResponseList.rOptionList" class="border border-blue-900 rounded bg-white p-2 text-blue-900 text-base font-bold my-1 hover:bg-blue-900 hover:text-white">{{item}}</p>
                            </div>

                        </div>
                    </td>
                </ng-container> -->


                <!-- Conversation Steps Column -->
                <ng-container matColumnDef="User Id">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50"> User Id </th>
                    <td mat-cell *matCellDef="let row">
                        <a class="w-44 text-amber-600 cursor-pointer" (click)="getUserIdData(row.userId)">
                            {{row.userId}}
                        </a>
                        <p *ngIf="filter.userId"></p>

                    </td>
                </ng-container>

                <!-- Conversation Steps Column -->
                <ng-container matColumnDef="Conversation Steps">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50 "> Conversation Steps </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="py-2 ">
                            <button mat-raised-button *ngIf="row.steps?.length > 1" (click)="openConversationDialog(row.steps,row.userId)" class="bg-zinc-900 text-gray-100  hover:bg-orange-500 rounded-sm w-44 text-lg">Conversation Steps
                        </button>
                            <div class="mt-3" *ngIf="row.steps?.length > 1">
                                <p class="text-sm font-medium ">NodeId: <span class="mx-1">{{row.steps[0].nodeId}}</span> </p>
                                <p class="break-words text-sm font-medium whitespace-normal"> Created At:&nbsp; {{changeDateFormate(row.steps[0].createdTime)}}</p>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- prediction Column -->
                <ng-container matColumnDef="prediction">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50"> prediction </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="maxHeight overflow-auto">
                            <div class="whitespace-pre-line" *ngFor="let item of row.predictions">
                                <p class="bg-orange-500 rounded-sm w-40 px-2 py-1  mt-2"> {{getPredictionName(item.predictionId)}}</p>
                            </div>
                        </div>

                    </td>
                </ng-container>


                <!-- Time Column -->
                <ng-container matColumnDef="Time">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50"> Time(KSA +3) </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="w-40">
                            <p>
                                {{addDate(row.created_time)}}
                                <!-- {{row.created_time}} -->
                            </p>
                        </div>

                    </td>
                </ng-container>


                <!-- SessionId Column -->
                <ng-container matColumnDef="SessionId">
                    <th mat-header-cell *matHeaderCellDef class="bg-[#4CAF50] text-slate-50"> SessionId </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="break-all whitespace-normal w-36">
                            <p>{{row.sessionId}}</p>
                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumnsConversation"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsConversation;"></tr>

            </table>
            <!-- <div *ngIf="dataSource.length === 0">No data</div> -->
            <mat-paginator [pageSize]="pageSize" [length]="conversationCount" [showFirstLastButtons]="true" class="sticky left-0">
            </mat-paginator>
        </mat-tab>

        <mat-tab label="Users  -{{messangerCount}}-">
            <table mat-table [dataSource]="dataSource">

                <!-- _id Column -->
                <ng-container matColumnDef="ID" sticky>
                    <th mat-header-cell *matHeaderCellDef class="bg-slate-50"> ID </th>
                    <td mat-cell *matCellDef="let row">
                        <a class="w-44 text-amber-600 cursor-pointer" (click)="getUserIdData(row._id)">{{row._id}}</a>
                    </td>
                </ng-container>

                <!-- User Column -->
                <ng-container matColumnDef="User" sticky>
                    <th mat-header-cell *matHeaderCellDef class="bg-slate-50"> User </th>
                    <td mat-cell *matCellDef="let row"> </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            </table>
            <mat-paginator [pageSize]="pageSize" [length]="totalItem" class="sticky left-0">
            </mat-paginator>
        </mat-tab>
    </mat-tab-group>
</div>
